<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    
    <title>Access Server</title>
    <style>
        html,
        body {
        height: 100%;
        }

        * {
            box-sizing: border-box;
        }

        body {
        max-width: 1500px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 15px;
        background-color: #f5f5f5;
        }

        .form {
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .form .form-floating:focus-within {
            z-index: 2;
        }
    </style>

    <script type="text/javascript">
        window._accTok = {} 
        window._userInfo = {}
        window._instInfo = {}

        window.register = async function() {
            const regName = document.getElementById('registerName').value

            const token = (await (await fetch('/user', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: regName }),
            })).json())
            
            document.getElementById('accessToken').value = token
            window.saveAccTok()
        }
        
        window.saveAccTok = async function() {
            window._accTok = document.getElementById('accessToken').value
            window._config = await (await fetch('/config')).json()
            window._userInfo = (await (await fetch(`/user?access_token=${window._accTok}`)).json())
            window._instInfo = (await (await fetch(`/instance?access_token=${window._accTok}`)).json())
            console.log(window._userInfo)
            document.getElementById('username').innerText = window._userInfo.name
            document.getElementById('token').innerText = window._userInfo.token
            updInst()
            updButtonDisabled()
        }

        window.reqInst = async function() {
            // document.getElementById('reqInst').style.display = 'none'
            window._instInfo = await (await fetch(`/instance?access_token=${window._accTok}`, { method: 'PUT' })).json()
            updInst()
            updButtonDisabled()
        }

        window.delInst = async function() {
            // document.getElementById('reqInst').style.display = 'none'
            window._instInfo = await (await fetch(`/instance?access_token=${window._accTok}`, { method: 'DELETE' })).text() | {}
            document.getElementById('id').innerText = ""
            document.getElementById('start_date').innerText = ""
            document.getElementById('end_date').innerText = ""
            document.getElementById('ssh_user').innerText = ""
            document.getElementById('ssh_pass').innerText = ""
            document.getElementById('ssh_host').innerText = ""
            document.getElementById('ssh_port').innerText = ""
            document.getElementById('ids_provider').innerText = ""
            document.getElementById('ids_consumer').innerText = ""
            updButtonDisabled()
        }

        const updInst = () => {
            if (!(window._instInfo && window._instInfo.ssh_user))
                return;
            document.getElementById('id').innerText = window._instInfo.id
            document.getElementById('start_date').innerText = window._instInfo.start_date
            document.getElementById('end_date').innerText = window._instInfo.end_date
            document.getElementById('ssh_user').innerText = window._instInfo.ssh_user
            document.getElementById('ssh_pass').innerText = window._instInfo.ssh_pass
            document.getElementById('ssh_host').innerText = window._config.SSH_HOST
            document.getElementById('ssh_port').innerText = window._instInfo.ssh_port
            document.getElementById('ids_provider').innerText = window._config.IDS_PROVIDER_PREFIX + window._instInfo.id + window._config.IDS_PROVIDER_POSTFIX
            document.getElementById('ids_consumer').innerText = window._config.IDS_CONSUMER_PREFIX + window._instInfo.id + window._config.IDS_CONSUMER_POSTFIX
        }

        const updButtonDisabled = () => {
            document.getElementById('reqInst').disabled = !!(window._instInfo && window._instInfo.ssh_user)
            document.getElementById('delInst').disabled = !(window._instInfo && window._instInfo.ssh_user)
        }
    </script>
</head>
<body class="row m-auto">
    <main class="form col-12 col-lg-9">
        <h1 class="h1 mb-3 fw-normal">Usability study for an intake based IDS Connector client</h1>
        <h4 class="h4 mb-3 fw-normal">Background</h4>
        <p>International Data Spaces standards enable technical, legal and organizational interoperability when sharing private data sets with across companies.
            Dataspace Connectors for IDS have been developed, but require considerable knowledge for set-up and integration.
            On the other hand most data-science research revolves around the use of lightweight technology.
            Data innovation labs like SDIL offer rapid turnover and facilitates collaborative research and innovation on data and offer "clean room" environments that are safe by design.</p>
        <h6 class="h6 mb-3 fw-normal">Problem statement</h6>
        <p>Precompetitive environments like data innovation labs and competitive operational environments differ fundamentally in their workflows.
            Porting concepts like IDS Connectors to precompetitive enviroments, as well as operating precompetitive environments with IDS technology is difficult.</p>
        <h6 class="h6 mb-3 fw-normal">Thesis idea</h6>
        <p>This thesis aims to build up a prototype platform (iSpace) that brings both concepts together and acts as a trusted infrastructure third party,
            that can particularly enforce securing and deleting data sets.
            The Data Provider thus allows the external Data Consumer to access data only on the premises of a Infrastructure Service Provider like an iSpace.</p>
        <h4 class="h4 mb-3 fw-normal">Usability study</h4>
        <h6 class="h6 mb-3 fw-normal">Setting and assumptions</h6>
        <p>You are a data scientist (Data Consumer) and planning on doing an experiment using meteorological data from the City of Karlsruhe (Data Provider).
            City of Karlsruhe (Data Provider) publishes this data on their IDS Connector (provider connector on the right panel) as a series of csv files along with some rules that dictate it's usage policy.
            Data Provider also legally limits your access to the data only from within iSpace infra (Infrastructure Service Provider / e.g. SDIL / what the form on the right represents).</p>
        <p>You are given access to iSpace infrastructure using an hosted Jupyter instance (Google Colab with a local runtime for the study).
            iSpace offers you (and everyone else) your own individual virtual machine that comes configured with a local IDS Connector (consumer connector on the right panel),
            an hosted Jupyter instance (instructions below on how to access), and SSH credentials to access the aforementioned two services via port forwarding (see the right panel.)
            In order to obtain the SSH credentials, you need an access token, which you had obtained previously during registration (this is the access token that I've given you).
            From within their Jupyter instance, you can reach the IDS Connector of the Data Provider (right panel)</p>
        <p><strong>Note:</strong> For the purposes of this study, you don't need to concern yourselves with the auth mechanisms of IDS. Consumer connector is using the default admin/password combo and auth with provider is taken care of.</p>
        <h6 class="h6 mb-3 fw-normal">Methodology</h6>
        <p>In the form on the right side, register, or if you already have an access token, enter it and click 'Save'. In order to create a new VM with SSH/Jupyter/local IDS connector, press the 'New Instance' button.
        Then use the following command to forward the hosted Jupyter instance in VM to your localhost:</p>
        <code>ssh [SSH User]@[SSH Host] -C -N -p [SSH PORT] -L 8888:localhost:8888</code>
        <p>Now you can connect to the Jupyter instance on iSpace using the local runtime option on Google Colab. If you are in the <strong>control group</strong>,
            please use <a href="https://colab.research.google.com/drive/1TFRIGvS8EWfi6UOo3pN3xdGB5616jhWQ?usp=sharing">this notebook on Colab</a>. If you are not, please use
            <a href="https://colab.research.google.com/drive/1OXUFOsNlWHti9roBVR9d8b1IgCdInwDI?usp=sharing">this</a>.</p>
        <p><a href="https://imgur.com/a/tg2bdxa">Here's a step-by-step explanation with images.</a></p>
        <h6 class="h6 mb-3 fw-normal">Objective</h6>
        <p>Continue from the Colab document.</p>
    </main>
    <main class="form col-12 col-lg-3" id="page1">
        <h4 class="h4 mb-3 fw-normal">Registration</h4>
        <small>If you already have an access token, skip to the next step.</small>

        <div class="form-floating">
            <input class="form-control" id="registerName">
            <label for="registerName">Name</label>
        </div>

        <button class="w-100 btn btn-lg btn-primary" onclick="window.register()">Register</button>

        <hr/>

        <h4 class="h4 mb-3 fw-normal">Access Token</h4>
        
        <div class="form-floating">
            <input class="form-control" id="accessToken">
            <label for="accessToken">Access Token</label>
        </div>
        
        <button class="w-100 btn btn-lg btn-primary" onclick="window.saveAccTok()">Save</button>

        <hr/>

        <h4 class="h4 mb-3 fw-normal">User Info</h4>
        
        <div>
            <div>Name: <span id="username"></span></div>
            <div class="mb-3">Token: <span id="token"></span></div>
        </div>
        
        <button disabled id="reqInst" class="w-100 btn btn-lg btn-primary" onclick="window.reqInst()">New Instance</button>
        <small>This may take ~20 seconds</small>

        <hr/>

        <h4 class="h4 mb-3 fw-normal">Instance Info</h4>
        
        <div>
            <div>Id: <span id="id"></span></div>
            <div>Start Date: <span id="start_date"></span></div>
            <div>End Date: <span id="end_date"></span></div>
            <div>SSH User: <span id="ssh_user"></span></div>
            <div>SSH Password: <span id="ssh_pass"></span></div>
            <div>SSH Host: <span id="ssh_host"></span></div>
            <div>SSH Port: <span id="ssh_port"></span></div>
            <div>Provider IDS Connector: <span id="ids_provider"></span></div>
            <div class="mb-3">Consumer (iSpace VM) IDS Connector: <span id="ids_consumer"></span></div>
        </div>

        <button disabled id="delInst" class="w-100 btn btn-lg btn-danger" onclick="window.delInst()">Delete Instance</button>
        <small>This may take ~10 seconds</small>
    </main>
</body>
</html>